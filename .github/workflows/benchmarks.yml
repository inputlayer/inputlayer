name: Benchmarks

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  BENCH_MAX_NODES: 1000
  CARGO_BUILD_JOBS: "2"

jobs:
  benchmark:
    name: Run Benchmarks
    if: contains(github.event.pull_request.labels.*.name, 'bench')
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: useblacksmith/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/release
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Build benchmarks
        run: cargo bench --bench production_benchmarks --no-run

      - name: Run benchmarks
        run: cargo bench --bench production_benchmarks -- "magic_sets|multi_hop|three_way" 2>&1 | tee bench_raw.txt

      - name: Build benchmark comment
        run: |
          python3 <<'PYEOF' > bench_comment.md
          import re

          lines = open("bench_raw.txt").readlines()

          benchmarks = []
          current_name = None
          current_time = None

          for line in lines:
              name_match = re.match(r'^(\w[\w/_ ]+\w)\s*$', line.rstrip())
              if name_match:
                  current_name = name_match.group(1).strip()
                  continue

              time_match = re.search(
                  r'time:\s+\[([0-9.]+\s+\w+)\s+([0-9.]+\s+\w+)\s+([0-9.]+\s+\w+)\]',
                  line
              )
              if time_match and current_name:
                  current_time = {
                      "name": current_name,
                      "lower": time_match.group(1),
                      "estimate": time_match.group(2),
                      "upper": time_match.group(3),
                      "change": "",
                      "note": "",
                  }
                  continue

              change_match = re.search(
                  r'change:\s+\[.*?([+-]?[0-9.]+%)\s+([+-]?[0-9.]+%)\s+([+-]?[0-9.]+%).*?\]',
                  line
              )
              if change_match and current_time:
                  current_time["change"] = change_match.group(2)
                  continue

              perf_match = re.search(r'(Performance has \w+|Change within noise|No change)', line)
              if perf_match and current_time:
                  note = perf_match.group(1)
                  if "improved" in note:
                      current_time["note"] = "improved"
                  elif "regressed" in note:
                      current_time["note"] = "regressed"
                  else:
                      current_time["note"] = "~same"
                  benchmarks.append(current_time)
                  current_time = None
                  current_name = None

          if current_time:
              benchmarks.append(current_time)

          out = []
          out.append("## Benchmark Results\n")

          key = [b for b in benchmarks if "magic_sets" in b["name"]]
          if key:
              out.append("### Magic Sets (Bound Recursive Queries)\n")
              out.append("| Benchmark | Time | vs. previous |")
              out.append("|-----------|------|-------------|")
              for b in key:
                  icon = {"improved": "\u2705", "regressed": "\u274c", "~same": "\u2796"}.get(b["note"], "")
                  change_str = f'{b["change"]} {icon}' if b["change"] else ""
                  out.append(f'| `{b["name"]}` | **{b["estimate"]}** | {change_str} |')
              out.append("")

          other = [b for b in benchmarks if "magic_sets" not in b["name"]]
          if other:
              out.append("<details>")
              out.append("<summary>All other benchmarks</summary>\n")
              out.append("| Benchmark | Time | vs. previous |")
              out.append("|-----------|------|-------------|")
              for b in other:
                  icon = {"improved": "\u2705", "regressed": "\u274c", "~same": "\u2796"}.get(b["note"], "")
                  change_str = f'{b["change"]} {icon}' if b["change"] else ""
                  out.append(f'| `{b["name"]}` | **{b["estimate"]}** | {change_str} |')
              out.append("")
              out.append("</details>")

          regressions = [b for b in benchmarks if b["note"] == "regressed"]
          if regressions:
              out.append("")
              out.append("> **\u26a0\ufe0f Regressions detected:**")
              for b in regressions:
                  out.append(f"> - `{b['name']}`: {b['change']}")

          print("\n".join(out))
          PYEOF

      - name: Post results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('bench_comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Benchmark Results')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
